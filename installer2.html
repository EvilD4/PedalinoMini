<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firmware Dropdown Generator</title>
</head>
<body>

<select id="firmware-select">
    <!-- Options will be dynamically populated here -->
</select>

<script>
    const GITHUB_REPO = "alf45tar/PedalinoMini";
    const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_REPO}/git/refs/tags`;

    const boards = {
        "esp32doit-devkit-v1": "Esp32 DOIT DevKit v1",
        "ttgo-t-eight": "TTGO T-Eight",
        "ttgo-t-display": "TTGO T-Display",
        "lilygo-t-display": "LilyGO T-Display",
        "heltec_wifi_kit_32": "Heltec WiFi Kit 32",
        "esp-wrover-kit": "ESP-WROVER-KIT",
        "bpi-leaf-s3": "BPI-Leaf-S3",
        "lilygo-t-display-s3": "LilyGO T-Display-S3"
    };

    async function fetchTags() {
        try {
            const response = await fetch(GITHUB_API_URL);
            const tags = await response.json();
            return tags;
        } catch (error) {
            console.error("Errore durante il recupero dei tag da GitHub:", error);
        }
    }

    async function checkFileExists(url) {
        try {
            const response = await fetch(url, { method: 'HEAD' });
            return response.ok;
        } catch (error) {
            console.error("Errore durante la verifica del file:", error);
            return false;
        }
    }

    async function generateDropdown() {
        const tags = await fetchTags();
        const selectElement = document.getElementById('firmware-select');

        for (const [boardKey, boardName] of Object.entries(boards)) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = boardName;

            for (const tag of tags) {
                const version = tag.ref.split('/').pop();
                const versionNumber = version.replace('v', '');
                const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/${version}/firmware/${boardKey}/${boardKey}-${versionNumber}.json`;
                
                const exists = await checkFileExists(url);
                if (exists) {
                    const option = document.createElement('option');
                    option.value = url;
                    option.textContent = `${boardName} ${versionNumber}`;
                    optgroup.appendChild(option);
                }
            }

            if (optgroup.children.length > 0) {
                selectElement.appendChild(optgroup);
            }
        }
    }

    generateDropdown();
</script>

</body>
</html>
