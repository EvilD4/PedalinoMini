<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firmware Dropdown Generator</title>
</head>
<body>

<select id="firmware-select">
    <!-- Options will be dynamically populated here -->
</select>

<script>
    // GitHub repository and API URL for fetching tags
    const GITHUB_REPO = "alf45tar/PedalinoMini";
    const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_REPO}/git/refs/tags`;

    // Mapping of board keys to their display names
    const boards = {
        "esp32doit-devkit-v1": "Esp32 DOIT DevKit v1",
        "ttgo-t-eight": "TTGO T-Eight",
        "ttgo-t-display": "TTGO T-Display",
        "lilygo-t-display": "LilyGO T-Display",
        "heltec_wifi_kit_32": "Heltec WiFi Kit 32",
        "esp-wrover-kit": "ESP-WROVER-KIT",
        "bpi-leaf-s3": "BPI-Leaf-S3",
        "lilygo-t-display-s3": "LilyGO T-Display-S3"
    };

    // Fetches tags from the GitHub repository
    async function fetchTags() {
        try {
            const response = await fetch(GITHUB_API_URL);
            const tags = await response.json();
            return tags;
        } catch (error) {
            console.error("Error fetching tags from GitHub:", error);
        }
    }

    // Compares two version numbers to determine order
    function compareVersions(v1, v2) {
        const parts1 = v1.split('.').map(Number);
        const parts2 = v2.split('.').map(Number);

        for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
            const part1 = parts1[i] || 0;
            const part2 = parts2[i] || 0;
            if (part1 > part2) return -1; // Newer version first
            if (part1 < part2) return 1;  // Older version later
        }
        return 0; // Versions are equal
    }

    // Checks if a JSON file exists at the given URL
    async function checkFileExists(url) {
        try {
            const response = await fetch(url, { method: 'HEAD' });
            return response.ok;
        } catch (error) {
            console.error("Error checking file existence:", error);
            return false;
        }
    }

    // Generates the dropdown menu by fetching and filtering versions
    async function generateDropdown() {
        const tags = await fetchTags(); // Get all tags from GitHub
        const selectElement = document.getElementById('firmware-select');

        const versionMap = {};

        // Iterate over all tags
        for (const tag of tags) {
            const versionNumber = tag.ref.split('/').pop().replace('v', ''); // Extract version number

            // Iterate over all boards
            for (const [boardKey, boardName] of Object.entries(boards)) {
                // Construct the URL for the JSON file
                const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/v${versionNumber}/firmware/${boardKey}/${boardKey}-${versionNumber}.json`;

                const exists = await checkFileExists(url); // Check if JSON file exists
                if (exists) {
                    if (!versionMap[boardName]) {
                        versionMap[boardName] = [];
                    }
                    versionMap[boardName].push({ versionNumber, url }); // Add to version map
                }
            }
        }

        // Generate dropdown options after filtering and sorting
        for (const [boardName, versions] of Object.entries(versionMap)) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = boardName;

            // Sort versions in descending order (newest first)
            versions.sort((a, b) => compareVersions(a.versionNumber, b.versionNumber));

            // Create option elements for each valid version
            for (const { versionNumber, url } of versions) {
                const option = document.createElement('option');
                option.value = url;
                option.textContent = `${boardName} ${versionNumber}`;
                optgroup.appendChild(option);
            }

            // Add the optgroup to the select element if it contains options
            if (optgroup.children.length > 0) {
                selectElement.appendChild(optgroup);
            }
        }
    }

    // Initiate dropdown generation on page load
    generateDropdown();
</script>

</body>
</html>
