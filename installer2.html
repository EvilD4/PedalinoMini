<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firmware Dropdown Generator</title>
</head>
<body>

<select id="firmware-select">
    <!-- Options will be dynamically populated here -->
</select>

<script>
    const GITHUB_REPO = "alf45tar/PedalinoMini";
    const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_REPO}/git/refs/tags`;

    const boards = {
        "esp32doit-devkit-v1": "Esp32 DOIT DevKit v1",
        "ttgo-t-eight": "TTGO T-Eight",
        "ttgo-t-display": "TTGO T-Display",
        "lilygo-t-display": "LilyGO T-Display",
        "heltec_wifi_kit_32": "Heltec WiFi Kit 32",
        "esp-wrover-kit": "ESP-WROVER-KIT",
        "bpi-leaf-s3": "BPI-Leaf-S3",
        "lilygo-t-display-s3": "LilyGO T-Display-S3"
    };

    async function fetchTags() {
        try {
            const response = await fetch(GITHUB_API_URL);
            const tags = await response.json();
            return tags;
        } catch (error) {
            console.error("Errore durante il recupero dei tag da GitHub:", error);
        }
    }

    function compareVersions(v1, v2) {
        const parts1 = v1.split('.').map(Number);
        const parts2 = v2.split('.').map(Number);

        for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
            const part1 = parts1[i] || 0;
            const part2 = parts2[i] || 0;
            if (part1 > part2) return -1;
            if (part1 < part2) return 1;
        }
        return 0;
    }

    async function checkFileExists(url) {
        try {
            const response = await fetch(url, { method: 'HEAD' });
            return response.ok;
        } catch (error) {
            console.error("Errore durante la verifica del file:", error);
            return false;
        }
    }

    async function generateDropdown() {
        const tags = await fetchTags();
        const selectElement = document.getElementById('firmware-select');

        // Estrarre le versioni dai tag e ordinarle
        const sortedTags = tags
            .map(tag => tag.ref.split('/').pop().replace('v', ''))
            .sort(compareVersions);

        for (const [boardKey, boardName] of Object.entries(boards)) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = boardName;

            for (const versionNumber of sortedTags) {
                const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/v${versionNumber}/firmware/${boardKey}/${boardKey}-${versionNumber}.json`;
                
                const exists = await checkFileExists(url);
                if (exists) {
                    const option = document.createElement('option');
                    option.value = url;
                    option.textContent = `${boardName} ${versionNumber}`;
                    optgroup.appendChild(option);
                }
            }

            if (optgroup.children.length > 0) {
                selectElement.appendChild(optgroup);
            }
        }
    }

    generateDropdown();
</script>

</body>
</html>
