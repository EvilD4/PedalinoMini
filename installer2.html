<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
    <title>Install PedalinoMini™</title>
    <style>
      div, fieldset, input, select { padding: 5px; font-size: 1em; }
      fieldset { background: #4f4f4f; }
      p { margin: 0.5em 0; }
      input, select { background: #dddddd; color: #000000; }
      input[type=checkbox], input[type=radio] { width: 1em; margin-right: 6px; vertical-align: -1px; }
      input[type=range] { width: 99%; }
      textarea { resize: vertical; width: 98%; height: 318px; padding: 5px; overflow: auto; background: #1f1f1f; color: #65c115; }
      body { text-align: center; font-family: verdana, sans-serif; background: #252525; }
      td { padding: 0px; }
      button { border: 0; border-radius: 0.3rem; background: #1fa3ec; color: #faffff; line-height: 2.4rem; font-size: 1.2rem; width: 100%; -webkit-transition-duration: 0.4s; transition-duration: 0.4s; cursor: pointer; }
      button:hover { background: #0e70a4; }
      .bred { background: #d43535; }
      .bred:hover { background: #931f1f; }
      .bgrn { background: #47c266; }
      .bgrn:hover { background: #5aaf6f; }
      a { color: #1fa3ec; text-decoration: none; }
      label { display: block; margin-top: 10px; color: #eaeaea; }
      select { width: 80%; background: #dddddd; color: #000000; margin: 0 auto; text-align: center; }
      .pick-variant { margin-bottom: 16px; text-align: center; }
      .dropdown-container { margin: 0 auto; display: inline-block; text-align: left; width: 70%; }
      #board-select, #version-select { width: 90%; }
    </style>
    <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
    <script type="module" src="https://www.improv-wifi.com/sdk-js/launch-button.js"></script>
  </head>
  <body>
    <div style='display:inline-block;color:#eaeaea;min-width:340px;'>

    <h1>PedalinoMini™ Installer</h1>

    <div class="pick-variant">
      <ol style='text-align:left'>
        <li>Connect the ESP device to your computer</br>using USB or serial-to-USB adapter</li></br>
        <li>Select the board and firmware variant suitable for</br>your device</li></br>
        <li>Hit "Connect" and select the correct port</br>or find help if <a href="https://tasmota.github.io/docs/Getting-Started/" target='_blank' style='color:#aaa;'>no device found</a></li>
      </ol>
      </br>

      <!-- Dropdown container for boards and versions -->
      <div class="dropdown-container">
        <label for="board-select">Select Board:</label>
        <select id="board-select">
          <option value="">Select Board</option>
        </select>

        <label for="version-select">Select Version:</label>
        <select id="version-select" disabled>
          <option value="">Select Version</option>
        </select>
      </div>

      <!-- Status message element for displaying scanning progress -->
      <div id="status-message">Scanning not started.</div>
      
      </br></br>
      <p>
        <esp-web-install-button manifest=''>
          <button slot='activate'>Connect via USB</button>
          <i slot="unsupported">
            Your browser does not support Web Serial.</br>Open this page in Google Chrome or</br>Microsoft Edge instead
            <span class="not-supported-i hidden">(but not on your iOS device)</span>.
          </i>
        </esp-web-install-button>
       </p>
       <p>or</p>
       <p>
        <improv-wifi-launch-button>
          <button slot='activate'>Connect via Bluetooth LE</button>
          <i slot="unsupported">
            Your browser does not support Web Bluetooth.</br>Visit this page with Google Chrome or<br>Microsoft Edge
            <span class="not-supported-i hidden">(but not on your iOS device)</span>.
          </i>
        </improv-wifi-launch-button>
      </p>
      <p>Events:</p>
      <pre id="events"></pre>
    <script>
        // Event listener for the version select dropdown
        document.querySelector('#version-select').addEventListener("change", (event) => {
            const button = document.querySelector('esp-web-install-button');
            button.manifest = event.target.value;
        });
    </script>
      <script>
        document.querySelectorAll("improv-wifi-launch-button").forEach((button) =>
          button.addEventListener("state-changed", (ev) => {
            document.querySelector("pre").innerText +=
              JSON.stringify(ev.detail) + "\n";
          })
        );
      </script>
    </div>
    <div style='text-align:right;font-size:11px;'>
      <hr/>
      <a href="https://esphome.github.io/esp-web-tools/" target='_blank' style='color:#aaa;'>PedalinoMini™ Installer powered by ESP Web Tools</a>
    </div>
    <script>
    const GITHUB_REPO = "alf45tar/PedalinoMini";
    const GITHUB_API_URL = `https://api.github.com/repos/${GITHUB_REPO}/git/refs/tags`;

    // Mapping of board keys to their display names
    const boards = {
        "esp32doit-devkit-v1": "Esp32 DOIT DevKit v1",
        "ttgo-t-eight": "TTGO T-Eight",
        "ttgo-t-display": "TTGO T-Display",
        "lilygo-t-display": "LilyGO T-Display",
        "heltec_wifi_kit_32": "Heltec WiFi Kit 32",
        "esp-wrover-kit": "ESP-WROVER-KIT",
        "bpi-leaf-s3": "BPI-Leaf-S3",
        "lilygo-t-display-s3": "LilyGO T-Display-S3"
    };

    // Fetch tags from the GitHub API
    async function fetchTags() {
        try {
            const response = await fetch(GITHUB_API_URL);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return await response.json();
        } catch (error) {
            console.error("Error fetching tags from GitHub:", error);
            document.getElementById('status-message').textContent = "Error fetching tags from GitHub.";
            return [];
        }
    }

    // Check if a specific file exists at the given URL
    async function checkFileExists(url) {
        try {
            const response = await fetch(url, { method: 'HEAD' });
            return response.ok;
        } catch (error) {
            console.error("Error checking file existence:", error);
            return false;
        }
    }

    // Populate the board dropdown
    function populateBoardDropdown() {
        const boardSelect = document.getElementById('board-select');
        for (const [boardKey, boardName] of Object.entries(boards)) {
            const option = document.createElement('option');
            option.value = boardKey;
            option.textContent = boardName;
            boardSelect.appendChild(option);
        }
    }

    // Sort versions by most recent first
    function sortVersions(versions) {
        return versions.sort((a, b) => {
            const versionA = a.split('.').map(Number);
            const versionB = b.split('.').map(Number);

            for (let i = 0; i < Math.max(versionA.length, versionB.length); i++) {
                const diff = (versionB[i] || 0) - (versionA[i] || 0);
                if (diff !== 0) return diff;
            }
            return 0;
        });
    }

    // Generate the version dropdown based on the selected board
    async function generateVersionDropdown(boardKey) {
        const versionSelect = document.getElementById('version-select');
        versionSelect.innerHTML = ''; // Clear existing options
        versionSelect.disabled = true; // Disable initially
        const statusMessage = document.getElementById('status-message');
        statusMessage.textContent = "Scanning in progress...";

        const tags = await fetchTags();

        if (tags.length === 0) {
            statusMessage.textContent = "No tags found or there was an error.";
            return;
        }

        let versions = [];

        for (const tag of tags) {
            const version = tag.ref.split('/').pop().replace('v', '');
            const url = `https://raw.githubusercontent.com/${GITHUB_REPO}/${version}/firmware/${boardKey}/${boardKey}-${version}.json`;

            const exists = await checkFileExists(url);
            if (exists) {
                versions.push(version);
            }
        }

        if (versions.length > 0) {
            versions = sortVersions(versions);

            // Populate the version dropdown
            versions.forEach(version => {
                const option = document.createElement('option');
                option.value = `https://raw.githubusercontent.com/${GITHUB_REPO}/${version}/firmware/${boardKey}/${boardKey}-${version}.json`;
                option.textContent = version;
                versionSelect.appendChild(option);
            });

            versionSelect.disabled = false;
            const button = document.querySelector('esp-web-install-button');
            button.manifest = versions[0].value;
            statusMessage.textContent = "Scanning completed.";
        } else {
            statusMessage.textContent = "No firmware files found for the selected board.";
        }
    }

    // Initialize the dropdowns
    document.addEventListener('DOMContentLoaded', () => {
        populateBoardDropdown();

        const boardSelect = document.getElementById('board-select');
        boardSelect.addEventListener('change', () => {
            const boardKey = boardSelect.value;
            if (boardKey) {
                generateVersionDropdown(boardKey);
            } else {
                document.getElementById('version-select').disabled = true;
            }
        });
    });
    </script>
  </body>
</html>
